##
##  xaric - irc client
##  Copyright (C) 1998, 1999, 2000, 2001 Rex Feany <laeos@laeos.net>
##
##  This file is part of Xaric, another broken irc client
##  which can be found at http://www.xaric.org/
##
##  This program is free software; you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation; either version 2 of the License, or
##  (at your option) any later version.
##
##  This program is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with this program; if not, write to the Free Software
##  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
##
##  @(#)Makefile.in 1.2
##

@SET_MAKE@

prefix      := @prefix@
exec_prefix := @exec_prefix@
bindir      := @bindir@
mandir      := @mandir@
srcdir      := @srcdir@
VPATH       := @srcdir@
datadir     := @datadir@
pkgdatadir  := $(datadir)/xaric
helpdir     := $(pkgdatadir)/help


CC          := @CC@
CFLAGS      := @CFLAGS@ @DEFS@
INCLUDES    := -Iinclude -I$(srcdir)/include
LDFLAGS     := @LDFLAGS@
LIBS        := @LIBS@
RM          := rm -f
SHTOOL      := $(srcdir)/shtool
MD5         := md5sum
REP_LIBS    := @REP_LIBS@
EXTRA       := @EXTRA_SRC@ @ALLOCA@
SED	    := sed
ACLOCAL     := @ACLOCAL@
AUTOCONF    := @AUTOCONF@
AUTOHEADER  := @AUTOHEADER@

VERSION_DIR     := $(srcdir)/source
VERSION_FILE    := version.c
VERSION_RFILE   := $(VERSION_DIR)/$(VERSION_FILE)
VERSION_NEW     := cd $(VERSION_DIR) && ../shtool version -l c -n 'xaric' -p x $$OPT $(VERSION_FILE)
VERSION         := `$(SHTOOL) version -d short $(VERSION_RFILE)`

AUTOHDR         := include/build.h include/fset_gen.h include/vars_gen.h


all: xaric

REALLY_INCLUDE := 1
include ${srcdir}/source/Makefile

SRCS += $(addprefix extra/, $(sort $(EXTRA)))
OBJS += $(SRCS:.c=.o) 

# Build xaric!
xaric: Makefile $(AUTOHDR) $(OBJS)
	$(CC) -o xaric $(CFLAGS) $(OBJS) $(LIBS)

# generate array indexes automagicly
include/fset_gen.h: source/fset.c
	cat $(srcdir)/source/fset.c | $(SED) -n -e "/\*--start--\*/,/\*--end--\*/ { s/^[^\"]*\"\([^\"]*\).*$$/\1_FSET,/; s/\/\*[^*]*\*\///; p; }" > $@

include/vars_gen.h: source/vars.c
	cat $(srcdir)/source/vars.c | $(SED) -n -e "/\*--start--\*/,/\*--end--\*/ { s/^[^\"]*\"\([^\"]*\).*$$/\1_VAR,/; s/\/\*[^*]*\*\///; p; }" > $@

install: installxaric installhelp installman
	@echo ""
	@echo "run 'make installdata' if you want the default datafiles installed"
	@echo ""

installxaric:
	$(SHTOOL) mkdir -f -p -m 755  $(bindir)
	$(SHTOOL) install -c xaric $(bindir)

installhelp:
	( $(SHTOOL) mkdir -f -p -m 755 $(helpdir) && \
		cd $(srcdir)/help && tar -cf - . | ( cd $(helpdir); tar -xf - ) )

installman:
	( $(SHTOOL) mkdir -f -p -m 755 $(mandir)/man1 && \
		for i in xaric.1; do $(SHTOOL) install -c $(srcdir)/doc/$$i $(mandir)/man1; done )

installdata:
	for i in servers; do $(SHTOOL) install -c $(srcdir)/doc/$$i $(pkgdatadir); done
 
# Supply some more information to the build
include/build.h: Makefile
	@echo \#define XARIC_DATA_PATH \"$(pkgdatadir)\" >> .ver
	@mv .ver $@

dep:
	$(CC) $(CFLAGS) $(INCLUDES) -MM -MG $(addprefix $(srcdir)/, $(SRCS)) | $(SED) -e "s/[^:]\+: .*\/\([^/ ]\+\)\/\([^ ]\+\)\.c/\1\/\2.o: \1\/\2.c/"  > .depend

clean:
	$(RM) $(OBJS)

distclean: clean
	$(RM) Makefile config.status config.log include/config.h include/stamp-h .depend
	$(RM) config.cache $(AUTOHDR) 
	$(RM) xaric

mtclean: distclean
	$(RM) aclocal.m4 configure include/config.h.in

.c.o:
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

########################################
# Rebuild autoconf files if needed     #
########################################

${srcdir}/configure: configure.in aclocal.m4 acinclude.m4
	cd ${srcdir} && $(AUTOCONF)

${srcdir}/include/config.h.in: ${srcdir}/include/stamp-h.in

${srcdir}/include/stamp-h.in: configure.in aclocal.m4 acinclude.m4 acconfig.h include/config.h.in
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/include/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

########################################
# Build the distribution files         #
########################################

# things that we should ignore when building the distribution tar
TARIGNORE = config.log,/config.h$$,^xaric$$,^Makefile$$,\
	    config.cache,config.status,SCCS,.depend,^xaric-\
	    BitKeeper,CVS,ChangeSet,.cvsignore,.[oa]$$

dist:
	@echo "Building distribution for Xaric v$(VERSION)"
	@cd $(srcdir) && ( ./shtool tarball -v -o xaric-$(VERSION).tar.gz -c 'gzip -9' -e '$(TARIGNORE)' . )
	@cd $(srcdir) && $(MD5) xaric-$(VERSION).tar.gz > xaric-$(VERSION).tar.gz.md5
	@echo "Done."

########################################
# Update version information           #
########################################

version:
	OPT=-iv && $(VERSION_NEW)
revision:
	OPT=-ir && $(VERSION_NEW)
patch:
	OPT=-il && $(VERSION_NEW)

# all done!


-include .depend
